<!DOCTYPE html>
<link rel=icon href=/favicon.png>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
  <title>Smart Quora</title>
  <script src='lib/jquery-1.8.0.min.js' type='text/javascript'></script>
  <script src='lib/jquery.slideto.min.js' type='text/javascript'></script>
  <script src='lib/jquery.wiggle.min.js' type='text/javascript'></script>
  <script src='lib/jquery.ba-bbq.min.js' type='text/javascript'></script>
  <script src="js/Alerts.js"></script>
  <script src="js/CommonUtils.js"></script>
  <script src="js/QuoraUtils.js"></script>
  <script type="text/javascript">
    const host = "https://ec2-35-168-150-155.compute-1.amazonaws.com:3000"
    const qurl = host + "/api/smartquora.question.Question/";
    const faqurl = host + "/api/queries/FindAllQuestions";
    const pingurl = host + "/api/system/ping";
    const loginurl = host + "/auth/google";
    const walleturl = host + "/api/wallet";
    const walletimporturl = host + "/api/wallet/import";



    function paintPage() {
      access_token = getAccessToken();
      console.log("Access Token :" + access_token);
      paintQuestions(access_token);
      paintWallet(walleturl, access_token);
    }

    function paintQuestions(accessToken) {
      getData(faqurl, accessToken)
        .then(function(data) {
          console.log("Questions: " + JSON.stringify(data, null, 2));
          for (var i = 0; i < data.length; i++) {
            question = data[i];
            addQuestionToTable(question["questionId"], question["questionDesc"], question["status"], question["stake"], question["balance"], question["timeCreated"], question["timeToAward"]);
          }
        })
        .catch(function(reason) {
          console.log(reason.message)
        });
    }


    function addQuestionToTable(questionId, questionDesc, status, stake, balance, timeCreated, timeToAward) {
      console.log("timeToAward: " + timeToAward);
      var due = new Date(timeToAward);
      var dueTS = due.toLocaleDateString() + " " + due.toLocaleTimeString();
      var tableBody = "q-table-body";
      var quotedQid = "\"/question.html?qid=" + questionId + "\"";
      var href = "<a  href=" + quotedQid + "><div class='font-weight-normal' align='left'>" + questionId + "</div></a>";
      var tableRef = document.getElementById(tableBody);
      var row = tableRef.insertRow(tableRef.rows.length);
      var cell0 = row.insertCell(0);
      cell0.innerHTML = href;
      var cell1 = row.insertCell(1);
      cell1.innerHTML = "<div class='font-weight-normal' align='left'>" + questionDesc + "</div>";;
      var cell2 = row.insertCell(2);
      cell2.innerHTML = "<div class='font-weight-normal' align='left'>" + status + "</div>";
      var cell3 = row.insertCell(3);
      cell3.innerHTML = "<div class='font-weight-normal' align='left'>" + stake + "</div>";
      var cell4 = row.insertCell(4);
      cell4.innerHTML = "<div class='font-weight-normal' align='left'>" + dueTS + "</div>";;
      console.log('Exiting addRow');
    }

    function paintWallet(walleturl, accessToken) {
      var selectRef = document.getElementById("available-cards");
      console.log("Fetching wallet data");
      getData(walleturl, accessToken)
        .then(function(data) {
          console.log("Wallet: " + JSON.stringify(data, null, 2));
          var currentCard;
          var currentCardName = "None";
          for (var i = 0; i < data.length; i++) {
            card = data[i];
            var opt = document.createElement('option');
            opt.value = card["name"];
            opt.innerHTML = card["name"];
            if (card["default"]) {
              currentCard = card;
              currentCardName = card["name"];
              opt.selectedIndex = i;
            }
            selectRef.appendChild(opt);
          }
          document.getElementById("current-card").value = currentCardName;
        })
        .catch(function(reason) {
          console.log("Wallet Fetch Failure: " + reason.message)
        });
    }

    function uploadCard0() {
      var cardName = document.getElementById("new-card-name").value;
      var cardFile = document.getElementById("card-file").value;
      if (cardName.length == 0) {
        alert("Error: Provide a card name");
      } else if (cardFile.length == 0) {
        alert("Error: Provide a valid card file");
      } else {
        var formElement = document.querySelector("upload-new-card");
        var request = new XMLHttpRequest();
        request.withCredentials = true;
        request.addEventListener("readystatechange", function() {
          if (this.readyState === 4) {
            console.log("******** XMLHttpRequest Status: " + this.responseText);
          }
        });
        request.open("POST", walletimporturl, false);
        var accessToken = getAccessToken();
        request.setRequestHeader("X-Access-Token", accessToken);
        request.setRequestHeader("Accept", "application/json");
        request.setRequestHeader("Cache-Control", "no-cache");
        request.send(new FormData(formElement));
        console.log("Upload Status: " + request.status);
      }
    }

    function uploadCard() {
      var cardName = document.getElementById("new-card-name").value;
      var cardFile = document.getElementById("card-file").value;
      if (cardName.length == 0) {
        alert("Error: Provide a card name");
      } else if (cardFile.length == 0) {
        alert("Error: Provide a valid card file");
      } else {
        var formData = new FormData();
        formData.append("name", cardName);
        formData.append("card", cardFile);
        console.log("cardName: "+cardName);
        console.log("cardFile: "+cardFile);
        //formData.append("card", document.getElementById("card-file").files[0]);
        var request = new XMLHttpRequest();
        request.withCredentials = true;
        request.addEventListener("readystatechange", function() {
          if (this.readyState === 4) {
            console.log("******** XMLHttpRequest Status: " + this.responseText);
          }
        });
        var accessToken = getAccessToken();
        console.log("walletimporturl: " + walletimporturl);
        request.open("POST", walletimporturl, false);
        request.setRequestHeader("X-Access-Token", accessToken);
        //request.setRequestHeader("Content-Type", "multipart/form-data");
        request.setRequestHeader("Accept", "application/json");
        request.setRequestHeader("Cache-Control", "no-cache");
        request.send(formData);
        console.log("Upload Status: " + request.status);
      }
    }

    function changeCard() {
      var dropdown = document.getElementById("available-cards");
      var selected = dropdown.options[dropdown.selectedIndex].value;
      var accessToken = getAccessToken();
      var setDefaultUrl = walleturl + "/" + selected + "/" + "setDefault";
      var message = "Digital Identity was changed to card: " + selected;
      var result = postToUrl204(setDefaultUrl, accessToken, message);
    }
  </script>
</head>


<a href="#"></a>

<body>
  <h1 class="display-3 text-center my-4 bg-dark text-light p-3">Smart Quora</h1>

  <div class="container">
    <!-- Wallet MODAL TRIGGER -->
    <button class="btn btn-info" data-toggle="modal" data-target="#walletModal">Wallet</button>
    <!-- Wallet MODAL -->
    <div class="modal" id="walletModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Wallet</h5>
            <button class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">

            <div class="card">
              <div class="card-header">
                Digital Identity Card
              </div>
              <div class="card-body">
                <div class="form-group">
                  <label for="current-card">Current Digital Identity Card</label>
                  <input type="text" placeholder="current-card" id="current-card" class="form-control" readonly>
                </div>
                <div class="form-group">
                  <label for="available-cards">Available Digital Identity Cards</label>
                  <select id="available-cards" class="form-control">
                  </select>
                </div>
                <div class="text-md-center">
                  <button class="btn btn-secondary" onclick="changeCard()" data-dismiss="modal">Change Card</button>
                </div>
              </div>
            </div>
            <p>&nbsp;</p>
            <div class="card">
              <div class="card-header">
                Upload New Digital Identity Card
              </div>
              <div class="card-body">
                <form name="upload-new-card">
                  <div class="form-group">
                    <label for="new-card-name">Card Name</label>
                    <input class="form-control form-control-sm" type="text" id="new-card-name" name="name" required="required" maxlength="10">
                    <label for="card-file">Import Card</label>
                    <input type="file" id="card-file" name="card" class="form-control-file" required>
                    <small id="fileHelp" class="form-text text-muted">Upload a valid digital identity card</small>
                    <div class="">
                      <p></p>
                    </div>
                    <div class="text-md-center">
                      <button class="btn btn-secondary" onclick="uploadCard()">Upload Card</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

          </div>
          <div class="modal-footer">
            <div class="text-md-center">
              <button class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Questions -->
    <h2 class="display-5 text-center my-4">Questions</h2>
    <div id="questions">
      <table id="q-table" class="table table-sm table-hover table-striped">
        <thead>
          <tr>
            <th>Id</th>
            <th>Question</th>
            <th>Status</th>
            <th>Stake</th>
            <th>Due</th>
          </tr>
        </thead>
        <tbody id="q-table-body">
        </tbody>
      </table>
    </div>
  </div>
  <hr>



  <div style="margin-top:500px;"></div>

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
  <script type="text/javascript">
    window.onload = paintPage();
  </script>
</body>

</html>
